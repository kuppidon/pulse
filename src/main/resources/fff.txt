package ua.pulse.component;

import com.vaadin.server.*;
import com.vaadin.server.communication.ServletBootstrapHandler;
import org.springframework.web.context.WebApplicationContext;
import org.springframework.web.context.support.WebApplicationContextUtils;

import java.util.List;

/**
 * Created by Alex on 24.01.2017.
 */
public class SpringVaadinServletService extends VaadinServletService {

    private String serviceUrl;

    /**
     * Create a servlet service instance that allows the use of a custom service
     * URL.
     *
     * @param servlet
     * @param deploymentConfiguration
     * @param serviceUrl
     *            custom service URL to use (relative to context path, starting
     *            with a slash) or null for default
     * @throws ServiceException
     */
    public SpringVaadinServletService(VaadinServlet servlet,
                                      DeploymentConfiguration deploymentConfiguration, String serviceUrl)
            throws ServiceException {
        super(servlet, deploymentConfiguration);
        this.serviceUrl = serviceUrl;
    }

    @Override
    protected List<RequestHandler> createRequestHandlers()
            throws ServiceException {
        List<RequestHandler> handlers = super.createRequestHandlers();
        // replace bootstrap handler with a custom one if service URL set
        if (serviceUrl != null) {
            // need to keep the position of the handler on the list
            for (int i = 0; i < handlers.size(); ++i) {
                if (handlers.get(i) instanceof ServletBootstrapHandler) {
                    handlers.set(i, new ServletBootstrapHandler() {
                        @Override
                        protected String getServiceUrl(BootstrapContext context) {
                            return context.getRequest().getContextPath()
                                    + serviceUrl;
                        }
                    });
                }
            }
        }
        return handlers;
    }

    /**
     * Find the Spring web application context related to the servlet context.
     *
     */
    public WebApplicationContext getWebApplicationContext() {
        return WebApplicationContextUtils
                .getWebApplicationContext(getServlet().getServletContext());
    }
}
